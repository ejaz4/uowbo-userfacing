model Tenant {
  id   String  @id @default(uuid())
  name String
  icon String?

  linkedPlatforms LinkedPlatforms?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LinkedPlatforms {
  id String @id @default(uuid())

  discordGuild DiscordGuild?

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  tenantId String @unique
}

model DiscordGuild {
  id   String  @id
  name String
  icon String?

  guildMembers DiscordGuildMember[]

  linkedTo   LinkedPlatforms? @relation(fields: [linkedToId], references: [id])
  linkedToId String?          @unique
}

model DiscordGuildMember {
  id String @id @default(uuid())

  discordGuild   DiscordGuild @relation(fields: [discordGuildId], references: [id])
  discordGuildId String

  discord              DiscordAccountLink @relation(fields: [discordAccountLinkId], references: [id])
  discordAccountLinkId String

  messages DiscordGuildMessage[]
  isOwner  Boolean               @default(false)

  joinedAt DateTime @default(now())

  @@unique([discordGuildId, discordAccountLinkId])
}

model DiscordGuildMessage {
  id String @id

  message String?

  mentions        DiscordGuildMessage[] @relation("mention")
  parentMessage   DiscordGuildMessage?  @relation("mention", fields: [parentMessageId], references: [id])
  parentMessageId String?

  user   DiscordGuildMember? @relation(fields: [userId], references: [id])
  userId String?

  attachmentUrl String?

  createdAt DateTime @default(now())
}

model LinkedAccounts {
  id String @id @default(uuid())

  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id])
  studentProfileId String         @unique

  discord DiscordAccountLink?
}

model DiscordAccountLink {
  id        String  @id
  username  String  @unique
  avatarUrl String?

  linkedAccounts   LinkedAccounts? @relation(fields: [linkedAccountsId], references: [id])
  linkedAccountsId String?         @unique

  sessions DiscordSession[]

  guilds DiscordGuildMember[]
}

model DiscordSession {
  id String @id @default(uuid())

  token String @unique

  escalationSecret String

  isAuthenticated Boolean @default(false)
  isRevoked       Boolean @default(false)

  discordAccountLink   DiscordAccountLink? @relation(fields: [discordAccountLinkId], references: [id])
  discordAccountLinkId String?
}

model VerificationMethods {
  id String @id @default(uuid())

  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id])
  studentProfileId String

  emailVerification EmailVerification[]
}

model EmailVerification {
  id               String @id @default(uuid())
  emailAddress     String
  verificationCode String

  isVerified            Boolean              @default(false)
  expiresAt             DateTime?
  verificationMethods   VerificationMethods? @relation(fields: [verificationMethodsId], references: [id])
  verificationMethodsId String?

  createdAt DateTime @default(now())
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model StudentProfile {
  id String @id @default(uuid())

  // Full name may be obtained via another service which could fill it in.
  fullName String?

  studentId  String? @unique
  isVerified Boolean @default(false)

  verificationMethods VerificationMethods[]
  linkedAccounts      LinkedAccounts?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserSettings {
  id String @id @default(uuid())

  language String @default("en")
}
